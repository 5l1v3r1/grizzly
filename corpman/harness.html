<!DOCTYPE html>
<html>
<head>
<meta charset=UTF-8>
<title>&#x1f43b; &sdot; Grizzly &sdot; &#x1f98a;</title>
<script>
let limit_tmr, closed_tmr, sub, time_limit = Number(location.hash.substr(1));
let req_url = '/first_test';
if (time_limit <= 0) {
  dump('No time limit given, using default of 5s\n');
  time_limit = 5000;
} else {
  dump('Using time limit of ' + time_limit + '\n');
}
let main = function(){
  sub = open(req_url, 'Grizzly Fuzz');
  sub.addEventListener('beforeunload', function(){
    closed_tmr = setInterval(function(){
      if (sub.closed) {
        clearTimeout(limit_tmr);
        clearInterval(closed_tmr);
        dump('Testcase closed itself\n');
        setTimeout(main, 0);
      }
    }, 10);
  });
  limit_tmr = setTimeout(function(){
    clearInterval(closed_tmr);
    dump('Time limit exceeded, closing it\n');
    sub.close();
    setTimeout(main, 0);
  }, time_limit);
  req_url = '/next_test';
};
window.onload = main;
window.addEventListener('beforeunload', function(){
  clearInterval(closed_tmr);
  clearTimeout(limit_tmr);
  dump('Cleaning up\n');
  if (!sub.closed) {
    sub.close();
  }
});
</script>
</head>
</html>
